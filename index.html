<div id="leaderboard"></div>

<script>
async function loadLeaderboard() {

  const res = await fetch("https://script.google.com/macros/s/AKfycbwB2ax4j0XVtl9pGp5b-JOQE4_fT5JRW9z2_4ziZjAhLjuKLpywUHHavv6I163njiYk/exec");
  const data = await res.json();

  let currentSort = "Score"; 
  let ascending = false;
  let showTimeInHrs = false; 
  let showStatsPage = false; // NEW toggle state

  const container = document.getElementById("leaderboard");

// Show a loading message immediately
container.innerHTML = `
  <div id="loadingScreen" style="text-align:center; color:#fff; font-size:24px; margin-top:50px;">
    üîÑ Who is awesome? YOU are! Say it aloud: 'I AM AWESOME!' Smile a big smile! Let the world see your brilliance. Every second you smile brings you closer to greatness!
  </div>
`;


  // Calculate class statistics
  const classStats = {
    totalQuests: data.reduce((sum,p)=> sum+Number(p.Quests||0),0),
    totalCorrect: data.reduce((sum,p)=> sum+Number(p.Correct||0),0),
    totalWrong: data.reduce((sum,p)=> sum+Number(p.Wrong||0),0),
    totalTime: data.reduce((sum,p)=> sum+Number(p.TotalTime||0),0),
    totalScore: data.reduce((sum,p)=> sum+Number(p.Score||0),0)
  };

  // Find last test taken
  let lastTestPlayer = data.reduce((prev, curr) => {
    if (!prev.LastTest) return curr;
    return new Date(curr.LastTest) > new Date(prev.LastTest) ? curr : prev;
  }, {});

  // Format LastTest time cleanly
  let lastTestTime = new Date(lastTestPlayer.LastTest);
  let formattedLastTest = lastTestTime.toLocaleString("en-GB", {
    year:"numeric", month:"short", day:"numeric",
    hour:"2-digit", minute:"2-digit"
  });

  container.innerHTML = `
    <style>
      @keyframes fadeSlideUp { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }

      body { background: radial-gradient(circle at 20% 20%, #0f2027, #203a43, #2c5364); color:#fff; font-family:'Segoe UI',sans-serif; margin:0;padding:10px; }
      
      .leaderboard-heading { text-align: center; font-size: 28px; font-weight: bold; margin: 20px 0; line-height: 1.3; letter-spacing: 2px; animation: fadeSlideUp 1s ease; }

      .emoji { display:inline-block; animation: spin 30.3s linear infinite, sparkle 30.5s ease-in-out infinite alternate; }
      @keyframes spin { 0% {transform: rotate(0deg) scale(1);} 50% {transform: rotate(180deg) scale(1.2);} 100% {transform: rotate(360deg) scale(1);} }
      @keyframes sparkle { 0% { text-shadow: 0 0 2px #fff, 0 0 5px #ffd700; } 50% { text-shadow: 0 0 4px #fff, 0 0 10px #ff0; } 100% { text-shadow: 0 0 2px #fff, 0 0 5px #ffd700; } }

      .timestamp { text-align:center; font-size:14px; color:#aaa; margin-bottom:15px; font-style:italic; }

      .table-container { width:100%; overflow:hidden; }
      table { width:100%; border-collapse:collapse; border-radius:15px; background: rgba(20,20,40,0.95); box-shadow:0 10px 25px rgba(0,0,0,0.5); animation: fadeSlideUp 1s ease-out; }
      th, td { padding:12px; text-align:center; font-size:15px; color:#ddd; border-bottom:1px solid rgba(255,255,255,0.1); word-wrap:break-word; }
      th { background: linear-gradient(135deg,#1e3c72,#2a5298); color:#fff; font-weight:bold; text-transform:uppercase; font-size:14px; letter-spacing:1px; cursor:pointer; }
      tr { transition: all 0.3s ease; }
      tr:hover { background: linear-gradient(135deg,#6a11cb,#2575fc); transform: scale(1.02); box-shadow:0 8px 20px rgba(0,0,0,0.6); color:#fff; }
      tr:hover td { color:#fff; text-shadow: 0 0 4px #fff, 0 0 8px #ff0; }
      tr.rank-1 td { background: gold; color:#000; font-weight:bold; }
      tr.rank-2 td { background: silver; color:#000; font-weight:bold; }
      tr.rank-3 td { background: #cd7f32; color:#fff; font-weight:bold; }

      button { margin:3px; padding:6px 12px; background:linear-gradient(135deg,#1e3c72,#2a5298); border:none; border-radius:8px; color:#fff; cursor:pointer; }
      button:hover { opacity:0.85; }

  .stats-grid { display:flex; flex-direction:column; gap:15px; margin-top:20px; }

.stat-card { 
  background: linear-gradient(135deg,#1c1f29,#2c2f3f); 
  padding:18px; 
  border-radius:15px; 
  text-align:center; 
  box-shadow:0 6px 20px rgba(0,0,0,0.6); 
  animation: fadeSlideUp 1s ease; 
  transition: transform 0.3s ease, box-shadow 0.3s ease; 
  border: 1px solid rgba(255,215,0,0.3);
}
.stat-card h3 { color:#d4af37; font-size:16px; margin:0; text-transform:uppercase; letter-spacing:1px; }
.stat-card p { color:#f5f5f5; font-size:22px; font-weight:bold; margin:8px 0 0; }

.stat-card:hover { transform: scale(1.03); box-shadow:0 8px 25px rgba(0,0,0,0.8); }

#totalTimeCard { 
  background: linear-gradient(135deg,#2a2a40,#3d3d5c); 
  box-shadow: 0 0 12px #d4af37, 0 0 25px rgba(212,175,55,0.8); 
  border: 1px solid #d4af37;
}
#totalTimeCard h3 { color:#ffd700; }
#totalTimeCard p { color:#fffacd; text-shadow:0 0 5px #ffd700; }

      .stat-card h3 { margin:0; font-size:16px; color:#aaa; }
      .stat-card p { margin:8px 0 0; font-size:20px; font-weight:bold; color:#fff; }

      @media (max-width: 600px) { th, td { font-size:14px; padding:8px; } .leaderboard-heading { font-size:22px; } }
    </style>

    <div class="leaderboard-heading">
      Mission: Veni, Vidi, Vici! <br>
      <span class="emoji">‚ú®</span><span class="emoji">üß©</span><span class="emoji">üöÄ</span> Leaderboard 
      <span class="emoji">üèÜ</span><span class="emoji">üèÖ</span><span class="emoji">üëë</span>
    </div>

    <div class="timestamp">Last Test Taken by <strong>${lastTestPlayer.Name}</strong> at ${formattedLastTest}</div>
    <div style="text-align:center;margin-bottom:15px;">
      <button id="pageToggleBtn">Show Class Stats</button>
    </div>
    <div id="sortButtons" style="text-align:center;margin-bottom:15px;"></div>
    <div class="table-container" id="leaderboardTableContainer"></div>
    <div class="table-container" id="classStatsContainer" style="display:none;"></div>
  `;

  // Sorting buttons
  const sortOptions = ["Score","Correct","Wrong","TotalTime","Quests","MainQuests","LastTest"];
  const sortButtons = document.getElementById("sortButtons");
  sortOptions.forEach(col => {
    const btn = document.createElement("button");
    btn.innerText = col === "MainQuests" ? "Sort by Videos" : `Sort by ${col}`;
    btn.addEventListener("click", () => {
      if (currentSort === col) ascending = !ascending;
      else { currentSort = col; ascending = false; }
      if(col === "TotalTime") {
        if(!document.getElementById("timeToggleBtn")) {
          const toggleBtn = document.createElement("button");
          toggleBtn.id = "timeToggleBtn";
          toggleBtn.innerText = "Show in hh:mm";
          toggleBtn.addEventListener("click", () => {
            showTimeInHrs = !showTimeInHrs;
            toggleBtn.innerText = showTimeInHrs ? "Show in seconds" : "Show in hh:mm";
            renderTable();
          });
          sortButtons.appendChild(toggleBtn);
        }
      } else {
        const existingBtn = document.getElementById("timeToggleBtn");
        if(existingBtn) existingBtn.remove();
      }
      renderTable();
    });
    sortButtons.appendChild(btn);
  });

  // Render leaderboard
  const renderTable = () => {
    const sortedData = [...data].sort((a,b) => {
      let valA = a[currentSort], valB = b[currentSort];
      if(currentSort === "LastTest") { valA = new Date(valA); valB = new Date(valB); }
      else if(typeof valA === "string") { valA = valA.toUpperCase(); valB = valB.toUpperCase(); }
      return ascending ? (valA > valB ? 1 : -1) : (valA > valB ? -1 : 1);
    });

    sortedData.forEach((player, idx) => player.Rank = idx+1);

    let html = `<table id="leaderboardTable">
      <thead><tr><th>Rank</th><th>Name</th><th>${currentSort}</th></tr></thead><tbody>`;
    
    sortedData.forEach((player,index) => {
      let rankDisplay = player.Rank;
      if(player.Rank==1) rankDisplay="ü•á";
      else if(player.Rank==2) rankDisplay="ü•à";
      else if(player.Rank==3) rankDisplay="ü•â";

      html+= `<tr class="rank-${player.Rank}" style="animation: fadeSlideUp 0.6s ease ${index*0.05}s forwards; opacity:0;">
                <td>${rankDisplay}</td>
                <td>${player.Name}</td>
                <td>${
                  currentSort === "LastTest" 
                    ? new Date(player.LastTest).toLocaleString("en-GB",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})
                    : currentSort === "TotalTime" && showTimeInHrs
                      ? `${Math.floor(player.TotalTime / 3600)}h ${Math.floor((player.TotalTime % 3600)/60)}m`
                      : player[currentSort]
                }</td>
              </tr>`;
    });
    html+= `</tbody></table>`;
    document.getElementById("leaderboardTableContainer").innerHTML = html;
  };

  // Render class statistics
const renderStats = () => {
 document.getElementById("classStatsContainer").innerHTML = `
    <div class="stats-grid">
      <div class="stat-card" id="totalTimeCard" style="cursor:pointer;">
        <h3>Total Time</h3>
        <p id="totalTimeNumber">${
          showTimeInHrs 
            ? `${Math.floor(classStats.totalTime/3600)}h ${Math.floor((classStats.totalTime%3600)/60)}m`
            : `${classStats.totalTime}s`
        }</p>
      </div>
      <div class="stat-card"><h3>Total Quests</h3><p>${classStats.totalQuests}</p></div>
      <div class="stat-card"><h3>Total Correct Answers</h3><p>${classStats.totalCorrect}</p></div>
      <div class="stat-card"><h3>Total Wrong Answers</h3><p>${classStats.totalWrong}</p></div>
      <div class="stat-card"><h3>Total Score</h3><p>${classStats.totalScore}</p></div>
    </div>

    <div class="table-container" style="margin-top:25px;">
      <h3 style="text-align:center;color:#ffd700;margin-bottom:10px;">"The world is moving so fast that to stay in place, we must keep running!" Lewis Carroll <br> ‚è±Ô∏è Greatness is measured in seconds!‚è±Ô∏è </h3>
      <table id="timeLeaderboard">
        <thead><tr><th>Rank</th><th>Name</th><th>Total Time</th></tr></thead>
        <tbody>
          ${[...data].sort((a,b)=>b.TotalTime - a.TotalTime).map((player,index)=>{
            let rankDisplay = index+1;
            if(rankDisplay===1) rankDisplay="ü•á";
            else if(rankDisplay===2) rankDisplay="ü•à";
            else if(rankDisplay===3) rankDisplay="ü•â";
            return `<tr>
              <td>${rankDisplay}</td>
              <td>${player.Name}</td>
              <td>${
                showTimeInHrs 
                  ? `${Math.floor(player.TotalTime / 3600)}h ${Math.floor((player.TotalTime % 3600)/60)}m`
                  : player.TotalTime+"s"
              }</td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;

  const totalTimeCard = document.getElementById("totalTimeCard");
  const totalTimeNumber = document.getElementById("totalTimeNumber");

  totalTimeCard.addEventListener("click", () => {
    showTimeInHrs = !showTimeInHrs;

    // Animate numbers racing from 0 to value
    if(!showTimeInHrs) {
      // Racing in seconds
      let current = 0;
      const target = classStats.totalTime;
      const increment = Math.ceil(target / 100); // 100 steps
      const interval = setInterval(() => {
        current += increment;
        if(current >= target) {
          current = target;
          clearInterval(interval);
        }
        totalTimeNumber.innerText = `${current}s`;
      }, 1); // adjust speed here
    } else {
      // Racing in hh:mm
      let totalSec = classStats.totalTime;
      let currentSec = 0;
      const increment = Math.ceil(totalSec / 100);
      const interval = setInterval(() => {
        currentSec += increment;
        if(currentSec >= totalSec) {
          currentSec = totalSec;
          clearInterval(interval);
        }
        const h = Math.floor(currentSec / 3600);
        const m = Math.floor((currentSec % 3600)/60);
        totalTimeNumber.innerText = `${h}h ${m}m`;
      }, 10);
    }
  });
};

  renderTable();
  renderStats();

  // Toggle button
  document.getElementById("pageToggleBtn").addEventListener("click", () => {
    showStatsPage = !showStatsPage;
    document.getElementById("leaderboardTableContainer").style.display = showStatsPage ? "none" : "block";
    document.getElementById("sortButtons").style.display = showStatsPage ? "none" : "block";
    document.getElementById("classStatsContainer").style.display = showStatsPage ? "block" : "none";
    document.getElementById("pageToggleBtn").innerText = showStatsPage ? "Show Leaderboard" : "Show Class Stats";
  });
}

loadLeaderboard();
</script>
