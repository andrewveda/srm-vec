<div id="leaderboard"></div>

<script>
async function loadLeaderboard() {
  const res = await fetch("https://script.google.com/macros/s/AKfycbwB2ax4j0XVtl9pGp5b-JOQE4_fT5JRW9z2_4ziZjAhLjuKLpywUHHavv6I163njiYk/exec");
  const data = await res.json();
  const columnDisplayNames = { "MainQuests": "Videos", "Wrong": "ELLL" };

  let currentSort = "Score", ascending = false, showTimeInHrs = false, showStatsPage = false;
  const container = document.getElementById("leaderboard");

  container.innerHTML = `
    <div style="text-align:center;color:#fff;font-size:20px;margin-top:40px;padding:10px;">
      üîÑ Who is awesome? YOU are! Smile, you‚Äôre glowing with greatness!
    </div>
  `;

  const classStats = {
    totalQuests: data.reduce((s,p)=>s+Number(p.Quests||0),0),
    totalCorrect: data.reduce((s,p)=>s+Number(p.Correct||0),0),
    totalWrong: data.reduce((s,p)=>s+Number(p.Wrong||0),0),
    totalTime: data.reduce((s,p)=>s+Number(p.TotalTime||0),0),
    totalScore: data.reduce((s,p)=>s+Number(p.Score||0),0)
  };

  let lastTestPlayer = data.reduce((a,b)=>!a.LastTest?b:new Date(b.LastTest)>new Date(a.LastTest)?b:a,{});
  let formattedLastTest = new Date(lastTestPlayer.LastTest).toLocaleString("en-GB",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});

  container.innerHTML = `
  <style>
    body { background: radial-gradient(circle at 20% 20%, #0f2027, #203a43, #2c5364); color:#fff; font-family:'Segoe UI',sans-serif; margin:0; padding:8px; }
    .leaderboard-heading { text-align:center;font-size:22px;font-weight:bold;margin:10px 0;line-height:1.3; }
    .timestamp { text-align:center;font-size:12px;color:#ccc;margin-bottom:10px; }
    .table-container { width:100%; overflow-x:auto; }
    table { width:100%; border-collapse:collapse; border-radius:10px; background:rgba(20,20,40,0.95); box-shadow:0 4px 10px rgba(0,0,0,0.4); }
    th, td { padding:8px; text-align:center; font-size:13px; color:#ddd; border-bottom:1px solid rgba(255,255,255,0.1); }
    th { background:linear-gradient(135deg,#1e3c72,#2a5298); text-transform:uppercase; font-size:12px; letter-spacing:0.5px; }
    tr:hover { background:linear-gradient(135deg,#6a11cb,#2575fc); color:#fff; transform:scale(1.01); }
    tr.rank-1 td { background:gold;color:#000;font-weight:bold; }
    tr.rank-2 td { background:silver;color:#000;font-weight:bold; }
    tr.rank-3 td { background:#cd7f32;color:#fff;font-weight:bold; }
    button { margin:3px;padding:6px 10px;font-size:13px;background:linear-gradient(135deg,#1e3c72,#2a5298);border:none;border-radius:6px;color:#fff;cursor:pointer; }
    button:hover { opacity:0.9; }
    .btn-wrap { display:flex;flex-wrap:wrap;justify-content:center;gap:4px;margin-bottom:10px; }
    .stats-grid { display:flex;flex-direction:column;gap:10px;margin-top:15px; }
    .stat-card { background:linear-gradient(135deg,#1c1f29,#2c2f3f); padding:14px; border-radius:10px; text-align:center; border:1px solid rgba(255,215,0,0.3); }
    .stat-card h3 { font-size:13px;color:#d4af37;margin:0; }
    .stat-card p { font-size:18px;font-weight:bold;margin:6px 0 0; }
    #totalTimeCard { background:linear-gradient(135deg,#2a2a40,#3d3d5c); border:1px solid #d4af37; }
    @media(max-width:600px){ th,td{font-size:12px;padding:6px;} .leaderboard-heading{font-size:20px;} button{font-size:12px;padding:5px 8px;} }
  </style>

  <div class="leaderboard-heading">üöÄ SRM VEC English Leaderboard üèÜ</div>
  <div class="timestamp">Last Test: <strong>${lastTestPlayer.Name}</strong> ‚Äî ${formattedLastTest}</div>
  <div style="text-align:center;margin-bottom:10px;"><button id="pageToggleBtn">Show Class Stats</button></div>
  <div class="btn-wrap" id="sortButtons"></div>
  <div class="table-container" id="leaderboardTableContainer"></div>
  <div class="table-container" id="classStatsContainer" style="display:none;"></div>
  `;

  const sortOptions = ["Score","Correct","Wrong","TotalTime","Quests","MainQuests","LastTest"];
  const sortButtons = document.getElementById("sortButtons");

  sortOptions.forEach(col=>{
    const btn=document.createElement("button");
    btn.innerText=`${columnDisplayNames[col]||col}`;
    btn.addEventListener("click",()=>{
      if(currentSort===col) ascending=!ascending; else {currentSort=col;ascending=false;}
      renderTable();
    });
    sortButtons.appendChild(btn);
  });

  const renderTable=()=>{
    const sorted=[...data].sort((a,b)=>{
      let A=a[currentSort],B=b[currentSort];
      if(currentSort==="LastTest"){A=new Date(A);B=new Date(B);}
      else if(typeof A==="string"){A=A.toUpperCase();B=B.toUpperCase();}
      return ascending?(A>B?1:-1):(A>B?-1:1);
    });
    sorted.forEach((p,i)=>p.Rank=i+1);
    let html=`<table><thead><tr><th>Rank</th><th>Name</th><th>${columnDisplayNames[currentSort]||currentSort}</th></tr></thead><tbody>`;
    sorted.forEach(p=>{
      let r=p.Rank==1?"ü•á":p.Rank==2?"ü•à":p.Rank==3?"ü•â":p.Rank;
      html+=`<tr class="rank-${p.Rank}"><td>${r}</td><td>${p.Name}</td><td>${
        currentSort==="LastTest"
        ? new Date(p.LastTest).toLocaleString("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})
        : currentSort==="TotalTime"&&showTimeInHrs
          ? `${Math.floor(p.TotalTime/3600)}h ${Math.floor((p.TotalTime%3600)/60)}m`
          : p[currentSort]
      }</td></tr>`;
    });
    html+=`</tbody></table>`;
    document.getElementById("leaderboardTableContainer").innerHTML=html;
  };

  const renderStats=()=>{
    document.getElementById("classStatsContainer").innerHTML=`
      <div class="stats-grid">
        <div class="stat-card" id="totalTimeCard"><h3>Total Time</h3><p>${classStats.totalTime}s</p></div>
        <div class="stat-card"><h3>Total Quests</h3><p>${classStats.totalQuests}</p></div>
        <div class="stat-card"><h3>Total Correct</h3><p>${classStats.totalCorrect}</p></div>
        <div class="stat-card"><h3>Total Wrong</h3><p>${classStats.totalWrong}</p></div>
        <div class="stat-card"><h3>Total Score</h3><p>${classStats.totalScore}</p></div>
      </div>`;
  };

  renderTable(); renderStats();

  document.getElementById("pageToggleBtn").addEventListener("click",()=>{
    showStatsPage=!showStatsPage;
    document.getElementById("leaderboardTableContainer").style.display=showStatsPage?"none":"block";
    document.getElementById("sortButtons").style.display=showStatsPage?"none":"flex";
    document.getElementById("classStatsContainer").style.display=showStatsPage?"block":"none";
    document.getElementById("pageToggleBtn").innerText=showStatsPage?"Show Leaderboard":"Show Class Stats";
  });
}
loadLeaderboard();
</script>
